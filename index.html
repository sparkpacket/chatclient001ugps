<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Merged Chat Client</title>
<link rel="icon" type="image/png" href="favicon.png">
<style>
  body {
    margin:0; font-family:monospace; background:#000; color:#0f0;
    display:flex; flex-direction:column; height:100vh; overflow:hidden;
  }
  #users { flex:0 0 auto; padding:10px; border-bottom:1px solid #0f0; font-size:12px; background:#000; }
  #userlist { display:block; list-style:none; padding:0; margin:0; }
  #chat { flex:1 1 auto; overflow-y:auto; padding:10px; border-bottom:1px solid #0f0; }
  #input-container { flex:0 0 auto; position:relative; background:#000; border-top:1px solid #0f0; padding:5px; }
  #privacy-note { position:absolute; top:-18px; right:10px; font-size:12px; color:#888; pointer-events:none; transition:all 0.3s ease; }
  #privacy-note.shrink { opacity:0.5; transform:scale(0.85); }
  #input { width:100%; padding:10px; background:#000; color:#0f0; border:none; font-family:monospace; font-size:14px; }
  .system { color:gray; font-style:italic; }
  .message { margin-bottom:5px; }
  .username { font-weight:bold; }
  .self { color:red !important; }
  #discord-note { position:fixed; top:10px; right:10px; background-color:#2b2b2b; color:white; padding:6px 10px; border-radius:4px; font-size:13px; z-index:9999; box-shadow:0 0 5px rgba(0,0,0,0.5);}
  #discord-note a { color:#7289da; text-decoration:none; }
  #discord-note a:hover { text-decoration:underline; }
</style>
</head>
<body>

<div id="users"><ul id="userlist"></ul></div>
<div id="chat"></div>

<div id="input-container">
  <div id="privacy-note">This site uses localStorage (cookies) to store information.</div>
  <input id="input" type="text" placeholder="Type a message..." autofocus autocomplete="off">
</div>

<div id="discord-note"><a href="https://discord.gg/kdwCbTjSvH" target="_blank">Join our Discord</a></div>

<script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
<script>
const ROOM_ID = 'hWmT5ZuGe51IgiMD';
let currentRoom = 'observable-room';

// Local user settings
let username = localStorage.getItem('username') || '';
let color = localStorage.getItem('color') || '#0f0';
let font = localStorage.getItem('font') || 'monospace';

function setUserSetting(type, value) {
  if(type==='name'){ localStorage.setItem('username', value); username=value; }
  if(type==='color'){ localStorage.setItem('color', value); color=value; }
  if(type==='font'){ localStorage.setItem('font', value); font=value; }
}

// Initialize Scaledrone
const drone = new Scaledrone(ROOM_ID, { data:{ name: username, color, font } });
let clientId = null;
let members = [];

drone.on('open', err => { if(err) return console.error(err); clientId = drone.clientId; });

let room = drone.subscribe(currentRoom);

function subscribeToRoom(roomName){
  if(room) room.unsubscribe();
  currentRoom = roomName;
  room = drone.subscribe(currentRoom);

  room.on('open', err => { if(err) console.error(err); });
  room.on('members', m => { members = m; updateUserList(); addSystemMessage(`Switched to room: ${displayRoomName(currentRoom)}`); });
  room.on('member_join', member => { members.push(member); updateUserList(); addSystemMessage(`${getName(member)} joined at ${getTime()}`); });
  room.on('member_leave', ({id}) => { const i = members.findIndex(m=>m.id===id); if(i!==-1){ addSystemMessage(`${getName(members[i])} left at ${getTime()}`); members.splice(i,1); updateUserList(); } });
  room.on('data', (data, member) => { handleIncomingMessage(data, member); });
}

// Listen to room events
room.on('open', err => { if(err) console.error(err); });
room.on('members', m => { members = m; updateUserList(); addSystemMessage(`${username||'You'} joined`); });
room.on('member_join', member => { members.push(member); updateUserList(); addSystemMessage(`${getName(member)} joined at ${getTime()}`); });
room.on('member_leave', ({id}) => { const i=members.findIndex(m=>m.id===id); if(i!==-1){ addSystemMessage(`${getName(members[i])} left at ${getTime()}`); members.splice(i,1); updateUserList(); } });
room.on('data', (data, member) => { handleIncomingMessage(data, member); });

function handleIncomingMessage(data, member){
  if(!member) return;
  if(typeof data==='string') addMessage(getName(member), data, member.
