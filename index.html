<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>sparkpacket's chat program</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    body {
      margin:0;
      font-family:monospace;
      background:#000;
      color:#0f0;
      display:flex;
      flex-direction:column;
      height:100vh;
      overflow:hidden; /* lock page scrolling */
    }

    /* User bar fixed */
    #users {
      flex: 0 0 auto;
      padding:10px;
      border-bottom:1px solid #0f0;
      font-size:12px;
      background:#000;
    }
    #userlist {
      display: block;
      grid-auto-flow: column;
      grid-template-rows: repeat(auto-fill, minmax(14px, auto));
      gap: 2px 20px;
      list-style:none;
      padding:0;
      margin:0;
    }

    /* Chat takes remaining space and is scrollable */
    #chat {
      flex: 1 1 auto;
      overflow-y:auto;
      padding:10px;
      border-bottom:1px solid #0f0;
    }

    /* Input and privacy bar fixed at bottom */
    #input-container {
      flex: 0 0 auto;
      position: relative;
      background: #000;
      border-top: 1px solid #0f0;
      padding: 5px;
    }

    #privacy-note {
      position: absolute;
      top: -18px;
      right: 10px;
      font-size: 12px;
      color: #888;
      background-color: rgba(0, 0, 0, 0);
      padding: 2px 6px;
      pointer-events: none;
      transition: all 0.3s ease;
    }
    #privacy-note.shrink {
      opacity: 0.5;
      transform: scale(0.85);
    }

    #input {
      width: 100%;
      padding: 10px;
      background:#000;
      color:#0f0;
      border:none;
      font-family:monospace;
      font-size:14px;
    }

    /* Messages */
    .system { color:gray; font-style:italic; }
    .message { margin-bottom:5px; }
    .username { font-weight:bold; }
    .self { color:red !important; }

    /* Discord note (unchanged) */
    #discord-note {
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: #2b2b2b;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      z-index: 9999;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }
    #discord-note a {
      color: #7289da;
      text-decoration: none;
    }
    #discord-note a:hover {
      text-decoration: underline;
    }
<script>
  const ROOM_ID = 'hWmT5ZuGe51IgiMD';
  let currentRoom = 'observable-room';

  // No default name
  let username = localStorage.getItem('username') || null;
  let color = localStorage.getItem('color') || '#0f0';
  let font = localStorage.getItem('font') || 'monospace';

  function setUserSetting(type, value) {
    if (type === 'name') {
      localStorage.setItem('username', value);
      username = value;
    }
    if (type === 'color') {
      localStorage.setItem('color', value);
      color = value;
    }
    if (type === 'font') {
      localStorage.setItem('font', value);
      font = value;
    }
    // Reconnect with new settings
    location.reload();
  }

  const drone = new Scaledrone(ROOM_ID, {
    data: { 
      username: username, // can be null
      color: color,
      font: font
    }
  });

  let clientId = null;
  let members = [];

  drone.on('open', err => {
    if (err) return console.error(err);
    clientId = drone.clientId;
  });

  let room = drone.subscribe(currentRoom);

  function subscribeToRoom(roomName) {
    if (room) room.unsubscribe();
    currentRoom = roomName;
    room = drone.subscribe(currentRoom);

    room.on('open', err => { if (err) console.error(err); });
    room.on('members', m => {
      members = m;
      updateUserList();
      addSystemMessage(`Switched to room: ${displayRoomName(currentRoom)}`);
    });
    room.on('member_join', member => {
      members.push(member);
      updateUserList();
      addSystemMessage(`${getName(member)} joined at ${getTime()}`);
    });
    room.on('member_leave', ({ id }) => {
      const i = members.findIndex(m => m.id === id);
      if (i !== -1) {
        addSystemMessage(`${getName(members[i])} left at ${getTime()}`);
        members.splice(i,1);
      }
      updateUserList();
    });
    room.on('data', (data, member) => {
      if (!member) return;
      if (data.type === 'html') addMessageHtml(getName(member), data.content, member.clientData);
      else if (data.type === 'text') addMessage(getName(member), data.content, member.clientData);
    });
  }

  room.on('members', m => {
    members = m;
    updateUserList();
    addSystemMessage(`${username || 'Unregistered'} joined`);
  });
  room.on('member_join', member => {
    members.push(member);
    updateUserList();
    addSystemMessage(`${getName(member)} joined at ${getTime()}`);
  });
  room.on('member_leave', ({ id }) => {
    const i = members.findIndex(m => m.id === id);
    if (i !== -1) {
      addSystemMessage(`${getName(members[i])} left at ${getTime()}`);
      members.splice(i,1);
    }
    updateUserList();
  });
  room.on('data', (data, member) => {
    if (!member) return;
    if (data.type === 'html') addMessageHtml(getName(member), data.content, member.clientData);
    else if (data.type === 'text') addMessage(getName(member), data.content, member.clientData);
  });

  function getName(member) {
    // If the member has no username (null), show whatever the server assigned
    return member.clientData?.username || '(no name)';
  }

  function getTime() { return new Date().toLocaleTimeString(); }

  // Rest of your message/display functions remain unchanged

</script>


<div id="discord-note">
  <a href="https://discord.gg/kdwCbTjSvH" target="_blank">Join our Discord</a>
</div>

</body>
</html>
